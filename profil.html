<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil utilisateur - Gascom Esport</title>
    <link rel="icon" type="image/png" href="assets/Ges-white.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700;900&family=Russo+One&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --accent: #ff6b35;
            --accent-strong: #d94a1f;
            --text-primary: #ffffff;
            --text-muted: rgba(255, 255, 255, 0.7);
            --panel-bg: linear-gradient(135deg, rgba(18, 18, 28, 0.9), rgba(42, 20, 16, 0.78));
            --panel-border: rgba(156, 44, 23, 0.45);
            --shadow-strong: 0 20px 40px rgba(0, 0, 0, 0.35);
        }

        body {
            background: #0b0b0f;
            color: var(--text-primary);
            padding-top: 92px;
        }

        .profile-wrapper {
            max-width: 820px;
            margin: 2rem auto 4rem;
            padding: 0 1.5rem;
        }

        .profile-hero-card {
            background: var(--panel-bg);
            border-radius: 22px;
            box-shadow: var(--shadow-strong);
            overflow: hidden;
        }

        .profile-banner {
            height: 180px;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.35), rgba(30, 15, 10, 0.9));
            position: relative;
        }

        .profile-banner::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.15), transparent 60%);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 22px;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 2rem;
            bottom: -50px;
            z-index: 2;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-initials {
            font-weight: 800;
            font-size: 2rem;
            letter-spacing: 1px;
            color: #fff;
        }

        .profile-info {
            padding: 4.5rem 2rem 2rem;
        }

        .profile-main {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1.5rem;
        }

        .profile-actions {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .profile-action-btn {
            border: none;
            background: rgba(255, 107, 53, 0.18);
            color: #fff;
            padding: 0.6rem 1.1rem;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .profile-action-btn.outline {
            background: transparent;
            border: 1px solid rgba(255, 107, 53, 0.4);
        }

        .profile-action-status {
            margin-top: 0.6rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .profile-name {
            font-family: 'Russo One', sans-serif;
            font-size: 2rem;
            margin-bottom: 0.4rem;
        }

        .profile-bio {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.6;
        }

        .profile-status {
            margin-top: 1.5rem;
            color: var(--text-muted);
            text-align: center;
        }

        .profile-lanes {
            display: flex;
            gap: 0.6rem;
            margin-top: 0.8rem;
            flex-wrap: wrap;
        }

        .lane-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.7rem;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.85);
        }

        .lane-chip img {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            object-fit: cover;
        }

        .profile-media {
            margin-top: 2rem;
            background: var(--panel-bg);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: var(--shadow-strong);
        }

        .profile-media h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .profile-media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.8rem;
        }

        .profile-media-card {
            position: relative;
            border-radius: 14px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.35);
            aspect-ratio: 1 / 1;
        }

        .profile-media-card img,
        .profile-media-card video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .profile-media-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 0.2rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
        }

        .profile-lightbox {
            position: fixed;
            inset: 0;
            background: rgba(5, 5, 8, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .profile-lightbox.active {
            display: flex;
        }

        .profile-lightbox-content {
            position: relative;
            max-width: 92vw;
            max-height: 88vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-lightbox img,
        .profile-lightbox video {
            max-width: 92vw;
            max-height: 88vh;
            border-radius: 12px;
            background: #000;
        }

        .profile-lightbox img {
            cursor: zoom-in;
            transition: transform 0.2s ease;
        }

        .profile-lightbox img.zoomed {
            transform: scale(1.6);
            cursor: zoom-out;
        }

        .profile-lightbox-close {
            position: absolute;
            top: -16px;
            right: -16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            font-size: 1.4rem;
            cursor: pointer;
        }

        @media (max-width: 680px) {
            .profile-avatar {
                left: 50%;
                transform: translateX(-50%);
            }

            .profile-info {
                padding: 5rem 1.2rem 1.5rem;
                text-align: center;
            }

            .profile-main {
                flex-direction: column;
                align-items: center;
            }

            .profile-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <header>
        <div class="header-content">
            <div class="logo-container">
                <div class="logo-icon">
                    <img src="assets/Ges-white.png" alt="Gascom Esport Logo" class="logo-img">
                </div>
                <div class="logo-text">Gascom Esport</div>
            </div>
            <nav>
                <button class="hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="username-display-mobile" id="usernameDisplayMobile" style="display: none;">
                    <span id="usernameMobileNav"></span>
                    <button onclick="handleLogout()" class="logout-mobile-btn" title="Déconnexion">
                        <i class='bx bx-log-out'></i>
                    </button>
                </div>
                <ul class="nav-menu" id="navMenu">
                    <li class="nav-item"><a href="/">Accueil</a></li>
                    <li class="nav-item"><a href="/equipe">Équipe</a></li>
                    <li class="nav-item"><a href="/compositions">Compositions</a></li>
                    <li class="nav-item"><a href="/tournois">Tournois</a></li>
                    <li class="nav-item"><a href="/galerie">Galerie</a></li>
                    <li class="nav-item"><a href="/contact">Contact</a></li>
                    <li class="nav-item"><a href="/apropos">A propos</a></li>
                    <li class="nav-item"><a href="/profils">Profils</a></li>
                    <li class="nav-item"><a href="/chat"><i class='bx bx-message'></i> Chat</a></li>
                    <li class="nav-item auth-nav" id="authNav">
                        <button class="auth-btn" onclick="openLoginModal()">Connexion</button>
                        <button class="auth-btn" onclick="openSignupModal()">Inscription</button>
                    </li>
                    <li class="nav-item user-nav" id="userNav" style="display: none;">
                        <span class="username-display" id="usernameNav"></span>
                        <a class="logout-btn" href="/mon-profil" title="Mon Profil" style="background: transparent; border: none; color: #FFFFFF; cursor: pointer; padding: 0.5rem; font-size: 1.2rem; text-decoration: none;">
                            <i class='bx bx-user-circle'></i>
                        </a>
                        <button class="logout-btn" onclick="handleLogout()">Déconnexion</button>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="profile-wrapper">
        <div class="profile-hero-card" id="profileCard" style="display: none;">
            <div class="profile-banner" id="profileBanner">
                <div class="profile-avatar" id="profileAvatar"></div>
            </div>
            <div class="profile-info">
                <div class="profile-main">
                    <div>
                        <div class="profile-name" id="profileName"></div>
                        <div class="profile-bio" id="profileBio"></div>
                        <div class="profile-lanes" id="profileLanes"></div>
                    </div>
                    <div class="profile-actions" id="profileActions">
                        <button class="profile-action-btn" id="profileMessageBtn"><i class='bx bx-message'></i> Message</button>
                        <button class="profile-action-btn outline" id="profileFriendBtn"><i class='bx bx-user-plus'></i> Ajouter ami</button>
                    </div>
                </div>
                <div class="profile-action-status" id="profileActionStatus"></div>
            </div>
        </div>

        <section class="profile-media" id="profileMediaSection" style="display: none;">
            <h3>Derniers médias</h3>
            <div class="profile-media-grid" id="profileMediaGrid"></div>
            <div class="profile-action-status" id="profileMediaStatus"></div>
        </section>

        <div class="profile-status" id="profileStatus">Chargement du profil...</div>
    </div>

    <div class="profile-lightbox" id="profileLightbox">
        <div class="profile-lightbox-content" id="profileLightboxContent">
            <button class="profile-lightbox-close" id="profileLightboxClose">×</button>
        </div>
    </div>

    <script src="auth-session.js"></script>
    <script>
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('navMenu');

        if (hamburger && navMenu) {
            hamburger.addEventListener('click', () => {
                navMenu.classList.toggle('active');
                hamburger.classList.toggle('active');
            });

            document.querySelectorAll('.nav-item a').forEach(link => {
                link.addEventListener('click', () => {
                    navMenu.classList.remove('active');
                    hamburger.classList.remove('active');
                });
            });
        }

        const params = new URLSearchParams(window.location.search);
        const userId = params.get('id');
        const username = params.get('u');
        const status = document.getElementById('profileStatus');
        const card = document.getElementById('profileCard');
        const actionStatus = document.getElementById('profileActionStatus');
        const messageBtn = document.getElementById('profileMessageBtn');
        const friendBtn = document.getElementById('profileFriendBtn');
        const banner = document.getElementById('profileBanner');
        const mediaSection = document.getElementById('profileMediaSection');
        const mediaGrid = document.getElementById('profileMediaGrid');
        const mediaStatus = document.getElementById('profileMediaStatus');

        let currentUser = null;

        async function loadCurrentUser() {
            const token = typeof getStoredToken === 'function' ? getStoredToken() : null;
            if (!token) return;

            try {
                const response = await fetch('/api/auth/session', {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (response.ok && data.user) {
                    currentUser = data.user;
                }
            } catch (error) {
                console.error(error);
            }
        }

        async function loadProfile() {
            if (!userId && !username) {
                status.textContent = 'Profil introuvable.';
                return;
            }

            const query = userId ? `profile=1&id=${encodeURIComponent(userId)}` : `profile=1&username=${encodeURIComponent(username)}`;

            try {
                const response = await fetch(`/api/users?${query}`);
                const data = await response.json();

                if (!response.ok || !data?.user) {
                    status.textContent = data?.error || 'Profil introuvable.';
                    return;
                }

                const displayName = data.user.username || 'Membre';
                document.getElementById('profileName').textContent = displayName;
                document.getElementById('profileBio').textContent = data.user.bio || 'Aucune bio pour le moment.';

                const avatar = document.getElementById('profileAvatar');
                avatar.innerHTML = '';
                if (data.user.avatar_url) {
                    const img = document.createElement('img');
                    img.src = data.user.avatar_url;
                    img.alt = displayName;
                    avatar.appendChild(img);
                    if (banner) {
                        banner.style.backgroundImage = `linear-gradient(135deg, rgba(255, 107, 53, 0.35), rgba(30, 15, 10, 0.9)), url('${data.user.avatar_url}')`;
                        banner.style.backgroundSize = 'cover';
                        banner.style.backgroundPosition = 'center';
                    }
                } else {
                    const initials = document.createElement('div');
                    initials.className = 'profile-initials';
                    initials.textContent = displayName.split(' ').map(part => part[0]).join('').slice(0, 2).toUpperCase();
                    avatar.appendChild(initials);
                }

                const lanesContainer = document.getElementById('profileLanes');
                const lanes = Array.isArray(data.user.lanes) ? data.user.lanes : [];
                const laneMeta = {
                    exp: { label: 'EXP', icon: 'assets/lane/exp.jpg' },
                    gold: { label: 'Gold', icon: 'assets/lane/gold.jpg' },
                    roamer: { label: 'Roamer', icon: 'assets/lane/roamer.jpg' },
                    jungler: { label: 'Jungler', icon: 'assets/lane/jungler.webp' },
                    mid: { label: 'Mid', icon: 'assets/lane/mid.webp' }
                };

                lanesContainer.innerHTML = '';
                lanes.slice(0, 2).forEach(lane => {
                    const meta = laneMeta[lane];
                    if (!meta) return;
                    const chip = document.createElement('span');
                    chip.className = 'lane-chip';
                    const icon = document.createElement('img');
                    icon.src = meta.icon;
                    icon.alt = meta.label;
                    chip.appendChild(icon);
                    chip.appendChild(document.createTextNode(meta.label));
                    lanesContainer.appendChild(chip);
                });

                status.textContent = '';
                card.style.display = 'block';

                setupActions(data.user);
                await loadUserMedia(data.user.id || userId, data.user.username || username);
            } catch (error) {
                status.textContent = 'Impossible de charger le profil.';
                console.error(error);
            }
        }

        function setActionStatus(message, type) {
            if (!actionStatus) return;
            actionStatus.textContent = message || '';
            actionStatus.classList.remove('error', 'success');
            if (type) actionStatus.classList.add(type);
        }

        function setupActions(profileUser) {
            if (!messageBtn || !friendBtn) return;

            if (currentUser && profileUser.id === currentUser.id) {
                messageBtn.style.display = 'none';
                friendBtn.style.display = 'none';
                return;
            }

            messageBtn.addEventListener('click', () => {
                const token = typeof getStoredToken === 'function' ? getStoredToken() : null;
                if (!token) {
                    openLoginModal();
                    return;
                }
                const target = profileUser.id ? `messageUserId=${encodeURIComponent(profileUser.id)}` : `messageUsername=${encodeURIComponent(profileUser.username || '')}`;
                window.location.href = `/profils?${target}`;
            });

            friendBtn.addEventListener('click', async () => {
                const token = typeof getStoredToken === 'function' ? getStoredToken() : null;
                if (!token) {
                    openLoginModal();
                    return;
                }

                setActionStatus('Envoi de la demande...', '');
                try {
                    const response = await fetch('/api/friends', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({ action: 'request', user_id: profileUser.id })
                    });

                    const data = await response.json();
                    if (!response.ok) {
                        setActionStatus(data.error || 'Impossible d\'envoyer la demande.', 'error');
                        return;
                    }

                    setActionStatus('Demande envoyée ', 'success');
                } catch (error) {
                    console.error(error);
                    setActionStatus('Erreur lors de l\'envoi.', 'error');
                }
            });
        }

        async function loadUserMedia(id, name) {
            if (!mediaSection || !mediaGrid || !mediaStatus) return;
            mediaSection.style.display = 'block';
            mediaGrid.innerHTML = '';
            mediaStatus.textContent = 'Chargement...';

            const query = id ? `userId=${encodeURIComponent(id)}` : `username=${encodeURIComponent(name || '')}`;
            try {
                const response = await fetch(`/api/media/user?${query}&limit=6`);
                const data = await response.json();

                if (!response.ok) {
                    mediaStatus.textContent = data.error || 'Impossible de charger les médias.';
                    return;
                }

                const posts = data.posts || [];
                if (posts.length === 0) {
                    mediaStatus.textContent = 'Aucun média pour le moment.';
                    return;
                }

                mediaStatus.textContent = '';
                posts.forEach(post => {
                    const card = document.createElement('div');
                    card.className = 'profile-media-card';

                    if (post.media_type === 'video') {
                        const video = document.createElement('video');
                        video.src = post.media_url;
                        video.muted = true;
                        video.playsInline = true;
                        video.preload = 'metadata';
                        card.appendChild(video);

                        const badge = document.createElement('div');
                        badge.className = 'profile-media-badge';
                        badge.textContent = 'Vidéo';
                        card.appendChild(badge);
                    } else {
                        const img = document.createElement('img');
                        img.src = post.media_url;
                        img.alt = post.caption || 'Media';
                        card.appendChild(img);
                    }

                    mediaGrid.appendChild(card);
                });
            } catch (error) {
                console.error(error);
                mediaStatus.textContent = 'Erreur lors du chargement.';
            }
        }

        const profileLightbox = document.getElementById('profileLightbox');
        const profileLightboxContent = document.getElementById('profileLightboxContent');
        const profileLightboxClose = document.getElementById('profileLightboxClose');

        function openProfileLightbox(target) {
            if (!profileLightbox || !profileLightboxContent) return;

            const existing = profileLightboxContent.querySelector('img, video');
            if (existing) existing.remove();

            let mediaEl;
            if (target.tagName.toLowerCase() === 'video') {
                mediaEl = document.createElement('video');
                mediaEl.controls = true;
                mediaEl.src = target.currentSrc || target.src;
                mediaEl.preload = 'metadata';
            } else {
                mediaEl = document.createElement('img');
                mediaEl.src = target.src;
                mediaEl.alt = target.alt || 'Media';
                mediaEl.addEventListener('click', () => {
                    mediaEl.classList.toggle('zoomed');
                });
            }

            profileLightboxContent.appendChild(mediaEl);
            profileLightbox.classList.add('active');
        }

        function closeProfileLightbox() {
            if (!profileLightbox) return;
            profileLightbox.classList.remove('active');
            const media = profileLightboxContent.querySelector('video');
            if (media) {
                media.pause();
            }
            const img = profileLightboxContent.querySelector('img');
            if (img) {
                img.classList.remove('zoomed');
            }
        }

        if (mediaGrid) {
            mediaGrid.addEventListener('click', (event) => {
                const target = event.target.closest('img, video');
                if (target) {
                    openProfileLightbox(target);
                }
            });
        }

        if (profileLightboxClose) {
            profileLightboxClose.addEventListener('click', closeProfileLightbox);
        }

        if (profileLightbox) {
            profileLightbox.addEventListener('click', (event) => {
                if (event.target === profileLightbox) {
                    closeProfileLightbox();
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeProfileLightbox();
            }
        });

        (async () => {
            await loadCurrentUser();
            await loadProfile();
        })();
    </script>
</body>
</html>
